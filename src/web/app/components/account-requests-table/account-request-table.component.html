<div class="card mb-3" *ngIf="accountRequests.length">
  <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
    <ng-container *ngIf="searchString; else pendingRequests">
      <strong>Account Requests Found</strong>
    </ng-container>
    <ng-template #pendingRequests>
      <strong>Pending Account Requests</strong>
    </ng-template>

    <div *ngIf="searchString" class="btn-group">
      <button 
        id="show-account-request-links" 
        class="btn btn-outline-light btn-sm" 
        type="button" 
        (click)="showAllAccountRequestsLinks()">
        Expand All
      </button>
      <button 
        id="hide-account-request-links" 
        class="btn btn-outline-light btn-sm" 
        type="button" 
        (click)="hideAllAccountRequestsLinks()">
        Collapse All
      </button>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-hover align-middle" id="search-table-account-request">
      <thead class="table-light">
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Status</th>
          <th>Institute, Country</th>
          <th>Created At</th>
          <th *ngIf="searchString">Registered At</th>
          <th>Comments</th>
          <th class="text-center">Options</th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let accountRequest of accountRequests; let i = index; trackBy: trackAccountRequest">
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <button 
                  class="btn btn-link p-0 me-2" 
                  (click)="accountRequest.showLinks = !accountRequest.showLinks"
                  [attr.aria-label]="accountRequest.showLinks ? 'Collapse' : 'Expand'">
                  <i class="fas" 
                    [class.fa-chevron-circle-down]="!accountRequest.showLinks" 
                    [class.fa-chevron-circle-up]="accountRequest.showLinks"
                  ></i>
                </button>
                <span [innerHtml]="accountRequest.name | highlighter:searchString:true"></span>
              </div>
            </td>
            <td [innerHtml]="accountRequest.email | highlighter:searchString:true"></td>
            <td [innerHtml]="accountRequest.status | highlighter:searchString:true"></td>
            <td [innerHtml]="accountRequest.instituteAndCountry | highlighter:searchString:true"></td>
            <td>{{ accountRequest.createdAtText }}</td>
            <td *ngIf="searchString">
              {{ accountRequest.registeredAtText || 'Not Registered Yet' }}
            </td>
            <td>
              <div [innerHtml]="accountRequest.comments | highlighter:searchString:true"></div>
            </td>
            <td class="text-center">
              <div class="btn-group btn-group-sm">
                <button 
                  id="edit-account-request-{{i}}" 
                  class="btn btn-outline-secondary"
                  (click)="$event.stopPropagation(); editAccountRequest(accountRequest);"
                  aria-label="Edit Request">
                  <i class="fa-solid fa-pen"></i>
                </button>
                
                <button 
                  id="view-account-request-{{i}}" 
                  class="btn btn-outline-secondary"
                  (click)="$event.stopPropagation(); viewAccountRequest(accountRequest);"
                  aria-label="View Request">
                  <i class="fa-solid fa-eye"></i>
                </button>
                
                <button 
                  id="delete-account-request-{{i}}" 
                  class="btn btn-outline-secondary" 
                  [disabled]="accountRequest.registeredAtText"
                  (click)="$event.stopPropagation(); deleteAccountRequest(accountRequest)"
                  aria-label="Delete Request">
                  <i class="fa-solid fa-trash"></i>
                </button>
                
                <button 
                  id="approve-account-request-{{i}}" 
                  class="btn btn-success"
                  [disabled]="!accountRequest.status || accountRequest.status === 'APPROVED' || accountRequest.status === 'REGISTERED' || isApprovingAccount[i]"
                  (click)="$event.stopPropagation(); approveAccountRequest(accountRequest, i)">
                  <tm-ajax-loading *ngIf="isApprovingAccount[i]"></tm-ajax-loading>
                  Approve
                </button>
                
                <div class="btn-group" ngbDropdown container="body">
                  <button 
                    id="reject-account-request-{{i}}" 
                    type="button" 
                    class="btn btn-warning" 
                    [disabled]="!accountRequest.status || accountRequest.status === 'REGISTERED' || accountRequest.status === 'APPROVED' || accountRequest.status === 'REJECTED' || isRejectingAccount[i]"
                    ngbDropdownToggle>
                    <tm-ajax-loading *ngIf="isRejectingAccount[i]"></tm-ajax-loading>
                    Reject
                  </button>
                  <div ngbDropdownMenu (click)="$event.stopPropagation()">
                    <button 
                      id="reject-request-{{i}}" 
                      class="dropdown-item"
                      (click)="$event.stopPropagation(); rejectAccountRequest(accountRequest, i)">Reject</button>
                    <button 
                      id="reject-request-with-reason-{{i}}" 
                      class="dropdown-item"
                      (click)="$event.stopPropagation(); rejectAccountRequestWithReason(accountRequest, i)">Reject With Reason</button>
                  </div>
                </div>
                
                <button 
                  *ngIf="searchString"
                  id="reset-account-request-{{i}}" 
                  class="btn btn-primary"
                  [disabled]="!accountRequest.registeredAtText || isResettingAccount[i]"
                  (click)="$event.stopPropagation(); resetAccountRequest(accountRequest, i)">
                  <tm-ajax-loading *ngIf="isResettingAccount[i]"></tm-ajax-loading>
                  Reset
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="accountRequest.showLinks && searchString">
            <td colspan="100">
              <ul class="list-group" @collapseAnim>
                <li class="list-group-item list-group-item-info">
                  <strong>Account Registration Link</strong>
                  <input [value]="accountRequest.registrationLink" disabled class="form-control mt-2">
                </li>
              </ul>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>
  </div>
</div>
